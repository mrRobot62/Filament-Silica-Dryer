// ESP32-S3 HMI (ESP32-1732S019N) + ST7789 170x320 (SPI)
// Offset-Finder (c/r/s) ohne LVGL – UART0 (Serial) Steuerung

#include <Arduino.h>
#include <Arduino_GFX_Library.h>

// --- Board Pins ---
#define LCD_DC 11
#define LCD_CS 10
#define LCD_SCK 12
#define LCD_MOSI 13
#define LCD_RST 1
#define LCD_BL 14

// --- Farben (RGB565) ---
#define C_BLACK 0x0000
#define C_WHITE 0xFFFF
#define C_MAGENTA 0xF81F

// Shared SPI-Bus (einmal anlegen, dann wiederverwenden)
Arduino_DataBus *sharedBus =
    new Arduino_ESP32SPI(LCD_DC, LCD_CS, LCD_SCK, LCD_MOSI, GFX_NOT_DEFINED);

// Panel-Pointer; wird bei jedem Set/Sweep neu erzeugt
Arduino_GFX *gfx = nullptr;

// aktuell gesetzte Offsets (rot1/3 = Landscape-relevant)
uint8_t g_col13 = 0;
uint8_t g_row13 = 0;

// ------------------------------------------
static void draw_frame()
{
    uint16_t W = gfx->width();  // erwartet 320
    uint16_t H = gfx->height(); // erwartet 170

    gfx->fillScreen(C_BLACK);

    // 2 px Magenta-Rahmen
    gfx->drawRect(0, 0, W, H, C_MAGENTA);
    gfx->drawRect(1, 1, W - 2, H - 2, C_MAGENTA);

    // weiße Außenlinien (zur Orientierung)
    gfx->drawFastVLine(0, 0, H, C_WHITE);
    gfx->drawFastVLine(W - 1, 0, H, C_WHITE);
    gfx->drawFastHLine(0, 0, W, C_WHITE);
    gfx->drawFastHLine(0, H - 1, W, C_WHITE);
}

static void init_panel(uint8_t col13, uint8_t row13)
{
    g_col13 = col13;
    g_row13 = row13;

    if (gfx)
    {
        delete gfx;
        gfx = nullptr;
    }

    // rot0/2-Offsets = 0/0 (Portrait – hier egal),
    // rot1/3-Offsets = gesuchte Werte (Landscape)
    gfx = new Arduino_ST7789(sharedBus, LCD_RST, 1 /* rotation */, true /* IPS */,
                             170, 320,
                             0, 0,            // rot0/2
                             g_col13, g_row13 // rot1/3
    );

    // konservativ 40 MHz; später kannst du 60/80 testen
    gfx->begin(40000000);
    gfx->setRotation(1);       // Landscape erzwingen
    gfx->invertDisplay(false); // neutral

    draw_frame();
}

// ------------------------------------------
static void help()
{
    Serial.println("Commands:");
    Serial.println("  c              -> column sweep (row=0, col 0..50)");
    Serial.println("  r              -> row sweep    (col=fixed, row 0..50)");
    Serial.println("  s <col> <row>  -> set offsets directly (e.g. 's 35 0')");
    Serial.println("  p              -> print current col/row and redraw");
    Serial.println();
}

// ------------------------------------------
void setup()
{
    // UART0 @ 115200 (du nutzt USB-UART-Adapter/serial-110)
    Serial.begin(115200);
    delay(200);

    pinMode(LCD_BL, OUTPUT);
    digitalWrite(LCD_BL, HIGH);

    help();
    init_panel(0, 0);
    Serial.println("Ready. Use 'c', 'r', 's col row', 'p'.");
}

void loop()
{
    if (!Serial.available())
        return;

    char cmd = Serial.read();

    if (cmd == 'c')
    {
        Serial.println("Column sweep (row=00)...");
        for (int col = 0; col <= 50; ++col)
        {
            init_panel(col, 0);
            Serial.printf("col=%02d row=00\n", col);
            delay(50); // schneller Durchlauf
        }
        Serial.println("Column sweep done.");
    }
    else if (cmd == 'r')
    {
        Serial.printf("Row sweep (col=%02d fixed)…\n", g_col13);
        for (int row = 0; row <= 50; ++row)
        {
            init_panel(g_col13, row);
            Serial.printf("col=%02d row=%02d\n", g_col13, row);
            delay(50);
        }
        Serial.println("Row sweep done.");
    }
    else if (cmd == 's')
    {
        // 's <col> <row>'
        while (Serial.peek() == ' ')
            Serial.read();
        int col = Serial.parseInt();
        while (Serial.peek() == ' ')
            Serial.read();
        int row = Serial.parseInt();
        if (col < 0)
            col = 0;
        if (col > 60)
            col = 60;
        if (row < 0)
            row = 0;
        if (row > 60)
            row = 60;
        init_panel((uint8_t)col, (uint8_t)row);
        Serial.printf("SET col=%02d row=%02d\n", g_col13, g_row13);
    }
    else if (cmd == 'p')
    {
        Serial.printf("CURRENT col=%02d row=%02d\n", g_col13, g_row13);
        draw_frame();
    }
    else if (cmd == 'h' || cmd == '?')
    {
        help();
    }
}