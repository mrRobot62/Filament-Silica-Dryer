[platformio]
default_envs = main

[common]
platform  = https://github.com/pioarduino/platform-espressif32/releases/download/51.03.07/platform-espressif32.zip
board     = esp32-s3-devkitc-1
framework = arduino

board_build.flash_size = 16MB
board_build.psram      = enabled

monitor_speed   = 115200
monitor_filters = direct, time
monitor_rts     = 0
monitor_dtr     = 0

; Common build flags used by all envs
common_build_flags =
  -DARDUINO_USB_MODE=0
  -DARDUINO_USB_CDC_ON_BOOT=0
  -DCORE_DEBUG_LEVEL=0
  -mfix-esp32-psram-cache-issue
  ; --- added: ensure lv_conf.h resolving from include/ ---
  -I include
  -DLV_CONF_INCLUDE_SIMPLE
  -DLV_CONF_PATH=\"lv_conf.h\"
  ; --- added: match your confirmed ST7789 pipeline ---
  -DLV_COLOR_DEPTH=16
  -DLV_COLOR_16_SWAP=1

; -----------------------------------------------------------------------------
; Main firmware (LVGL app later) – builds only sources under src/main/** (+ ui/**)
; -----------------------------------------------------------------------------
[env:main]
platform  = ${common.platform}
board     = ${common.board}
framework = ${common.framework}

board_build.flash_size = ${common.board_build.flash_size}
board_build.psram      = ${common.board_build.psram}

monitor_speed   = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
monitor_rts     = ${common.monitor_rts}
monitor_dtr     = ${common.monitor_dtr}

build_flags =
  ${common.common_build_flags}

; Pin your app libs here as needed:
lib_deps =
  adafruit/Adafruit BusIO
  adafruit/Adafruit MAX31856 library
  lvgl/lvgl@^9.4.0
  moononournation/GFX Library for Arduino@1.4.7
  mathertel/RotaryEncoder@^1.5.3

; Only compile the main app sources (+ ui/** so gfx_ui & heat_screen are built)
build_src_filter = 
  -<*>
  +<main/**>
  +<main/ui/**>
  +<main/sensors/RotarySwitch.cpp>
  +<main/sensors/rotary_input.cpp>
  +<main/rotary_handler.cpp>
; -----------------------------------------------------------------------------
; CLI_GFX rotary+display test – builds only sources under src/cli_gfx/**
; Uses Arduino-ESP32 Core 3.0.7 via platform URL above (IDF5 APIs needed by GFX 1.5)
; -----------------------------------------------------------------------------
[env:cli_gfx]
platform  = ${common.platform}
board     = ${common.board}
framework = ${common.framework}

board_build.flash_size = ${common.board_build.flash_size}
board_build.psram      = ${common.board_build.psram}

monitor_speed   = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
monitor_rts     = ${common.monitor_rts}
monitor_dtr     = ${common.monitor_dtr}

; Remove any pre-set USB flags and re-apply cleanly
build_unflags =
  -DARDUINO_USB_MODE
  -DARDUINO_USB_CDC_ON_BOOT

build_flags =
  ${common.common_build_flags}
  ;-DTEST_ROTARY
  -DLV_CONF_SKIP=1

; Only the files we need for the rotary test
build_src_filter =
  -<*>
  +<cli_gfx/cli_gfx.cpp>
  +<cli_gfx/RotarySwitch.cpp>
  +<cli_gfx/rotary_input.cpp>
  +<cli_gfx/gfx_ui.cpp>

; Libs required for this test only
lib_deps =
  moononournation/GFX Library for Arduino@1.4.7
  mathertel/RotaryEncoder@^1.5.3

; Exclude libs that would pull in Wire/I2C or extra deps not needed now
lib_ignore =
  Adafruit BusIO
  Adafruit MAX31856 library
  lvgl
  lvgl/lvgl